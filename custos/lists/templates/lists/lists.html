{% extends 'base.html' %}
{% load static %}

{% block title %} Lists {% endblock %}

{% block content %}

{% if user.is_authenticated %}
<div class="main-content">
    <h1 class="display-4 text-center">Welcome to Custos, {{ user.username }}</h1>
    <hr>
    <h1 class='pageheader'> My List </h1>

    <!-- Add Item modal -->
    <div class="container">
        <!-- Button trigger modal -->
        <button class="btn bg-primary-c text-white w-100" data-toggle="modal" data-target="#additemModal"> 
            <i class='fa fa-plus'> </i> Add New Item
        </button>
        
        
        <!-- Modal -->
        <div class="modal fade" id="additemModal" tabindex="-1" role="dialog" aria-labelledby="modelLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modelLabel">Add Item</h5>

                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>

                </div>
                <form v-on:submit.prevent="addItemForm" method="POST" class="modal-body">
                    <label for="itemname">Item Name</label>
                    <input type="text" class="form-control mb-3" name="itemname" id="itemname" required>
                    <label for="time">How long do you wish to quarantine?</label>
                    <input type="datetime-local" class="form-control mb-3" name="delta" id="time" required>
                    <button type="submit" class="btn btn-outline-success w-100">Add</button>
                </form>
            </div>
            </div>
        </div>
    </div>

    <br>

    <!--Card Deck containing the lists of items-->
    <div class="mt-3 custom-card-deck mx-auto" id="item-deck">

        <list-item
            v-for='item in itemsList'
            v-bind:item='item'
            v-bind:key='item.id'
            inline-template
        >
            {% verbatim %}
                <div class='custom-card list '>

                    <!-- Items in list -->
                    <div class='list-content'>
                        <!-- individual item -->
        
                    <div class="list-content-item">
                            <div class='input-group'>
                                <div class='input-group-prepend'>
                                    <button class="btn btn-danger" type="button" > {{item.delta}} </button>
                                </div>
                                <input type="text" readonly class="form-control form-control-plaintext" aria-label="Name of the Item" v-bind:value='item.name'>
        
                                <div class="input-group-append">
                                    <button class="btn btn-secondary" type="button" data-toggle="collapse" v-bind:data-target="'#itemno'+item.id">
                                        <i class='fa fa-chevron-circle-down'></i>
                                    </button>
                                </div>
                            </div>
                            <!-- collapsible for more information -->
                            <div class='extra-info collapse rounded border-botton-dark' v-bind:id="'itemno'+item.id">
        
                                <div class='extra-info-time'> 
                                    <!-- time it came in and date-->
                                    Arrival: {{item.created}}
                                    <br/>
                                    Safe By: {{item.expected_elapsed_timestamp}}
                                </div>
        
                                <div class='extra-info-image'> 
                                    <!-- Image, if Any -->
                                </div>
        
                                <div class='extra-info-shared-people'>
                                    <!-- People this item was shared with -->
                                </div>
        
                            </div>
        
                        </div> 
        
                    </div>
                </div>
            {% endverbatim %}
        </list-item>
        

        
        
    </div>
{% else %}
    <h1 class='pageheader'> Please Login to View this Page. </h1>
{% endif %}

{% endblock %}


{% block vue %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

//import listItem from '{% static "js/listitem.js" %}'
var url = "{% url 'useritems' id=user.id %}";
const user_id = '{{ user.id }}';
console.log(user_id);

axios.defaults.xsrfCookieName = 'csrftoken'
axios.defaults.xsrfHeaderName = "X-CSRFTOKEN"
</script>

{% verbatim %} 
<script>
    
    // Vue component to display the item
    Vue.component('list-item', {
        props: ['item'],
    })

    // Vue app (deck of items)
    var app = new Vue({

        el: "#item-deck",
        data: {
            itemsList:[],
        },
        // Once component is mounted it calls the Items API (Django) to fetch the users items
        mounted() {
            axios
                .get("http://localhost:8000"+url)
                .then(response => {
                    console.log(response);
                    this.itemsList = response.data;
                    })
                .catch(error => console.log(error))
        }

    });

    var modal = new Vue({
        el: "#additemModal",
        methods:{
            addItemForm : function(e){
                // function to add item

                // getting the form values
                var itemname = e.target['itemname'].value;
                var datetime = new Date(e.target['time'].value);

                // getting the current date
                var current_date = new Date();

                // time delta in seconds
                var delta = Math.floor((datetime.getTime() - current_date.getTime())/1000);

                // axios post request to send item data
                axios.post("http://localhost:8000"+url, {
                    headers: {
                        "X-CSRFToken": getCookie('csrftoken'),
                    },
                    data: {
                        "name" : itemname,
                        "time": delta,
                        "user_id": user_id
                    }
                })

            }
        }
    })

</script>
{% endverbatim %}
{% endblock  %}
